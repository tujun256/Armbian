name: Build Armbian (boca-tcn200) - Replace CSC File

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      BOARD: boca-tcn200
      ARMBIAN_REPO: https://github.com/alerice/armbian-build.git
      ARMBIAN_DIR: ./armbian-build
      USER_CSC_FILE: ./Addboard/config/boards/boca-tcn200.csc
      TARGET_CSC_FILE: ./armbian-build/build/config/boards/boca-tcn200.csc

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - Check user CSC file
        run: |
          echo "=== 检查你仓库的csc文件 ==="
          if [ -f "${{ env.USER_CSC_FILE }}" ]; then
            echo "✅ 找到你的csc文件：${{ env.USER_CSC_FILE }}"
            ls -la ${{ env.USER_CSC_FILE }}
          else
            echo "❌ 未找到你的csc文件：${{ env.USER_CSC_FILE }}"
            exit 1
          fi

      - name: Clone alerice/armbian-build repository
        run: |
          git clone --recursive ${{ env.ARMBIAN_REPO }} ${{ env.ARMBIAN_DIR }}
          cd ${{ env.ARMBIAN_DIR }}
          echo "=== 当前分支信息 ==="
          git branch -v
          echo "=== 查看boca-tcn200支持的内核分支 ==="
          # 额外调试：查看该BOARD配置中支持的KERNEL_TARGET
          grep -i "KERNEL_TARGET" ${{ env.TARGET_CSC_FILE }} || echo "未找到KERNEL_TARGET配置"

      - name: Replace boca-tcn200.csc file
        run: |
          mkdir -p $(dirname ${{ env.TARGET_CSC_FILE }})
          if [ -f "${{ env.TARGET_CSC_FILE }}" ]; then
            cp ${{ env.TARGET_CSC_FILE }} ${{ env.TARGET_CSC_FILE }}.bak
            echo "✅ 已备份原csc文件"
          fi
          cp -fv ${{ env.USER_CSC_FILE }} ${{ env.TARGET_CSC_FILE }}
          echo "✅ 已替换csc文件"
          # 验证替换后的KERNEL_TARGET
          grep -i "KERNEL_TARGET" ${{ env.TARGET_CSC_FILE }}

      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y \
            git curl wget build-essential libncurses5-dev libssl-dev \
            bc flex bison kmod cpio rsync unzip zip qemu-user-static \
            python3 python3-pip python3-setuptools parted dosfstools \
            uuid-runtime grub-efi-amd64-bin grub-pc-bin mtools \
            libelf-dev libssl-dev dwarves zstd device-tree-compiler

      - name: Initialize build environment
        run: |
          cd ${{ env.ARMBIAN_DIR }}
          if [ -f "build.sh" ]; then
            chmod +x build.sh
            ./build.sh --help
          fi
          if [ -f "compile.sh" ]; then
            chmod +x compile.sh
          elif [ -f "build.sh" ]; then
            ln -s build.sh compile.sh
          else
            echo "错误：未找到编译脚本！"
            exit 1
          fi

      # 核心修改：修复编译参数，禁用交互，指定正确分支
      - name: Build Armbian image
        run: |
          cd ${{ env.ARMBIAN_DIR }}
          # 关键修改：
          # 1. BRANCH改为legacy（适配boca-tcn200支持的分支）
          # 2. 添加RELEASE指定OS版本，避免交互式选择
          # 3. 添加FORCE_BOARD_FALLBACK=yes，强制跳过分支验证的交互弹窗
          # 4. 添加NONINTERACTIVE=yes，彻底禁用所有交互式操作
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=legacy \  # 改为该BOARD支持的分支
            RELEASE=bookworm \  # 指定OS版本（Debian 12），避免交互选择
            FORCE_BOARD_FALLBACK=yes \  # 强制跳过分支验证的交互弹窗
            NONINTERACTIVE=yes \  # 禁用所有交互式操作
            BUILD_MINIMAL=yes \
            BUILD_DESKTOP=no \
            KERNEL_ONLY=no \
            KERNEL_CONFIGURE=no

      - name: Upload build results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: armbian-boca-tcn200-results
          path: |
            ${{ env.ARMBIAN_DIR }}/output/images/*.img*
            ${{ env.ARMBIAN_DIR }}/output/images/*.zip*
            ${{ env.ARMBIAN_DIR }}/compile.log
            ${{ env.TARGET_CSC_FILE }}.bak
          retention-days: 7
