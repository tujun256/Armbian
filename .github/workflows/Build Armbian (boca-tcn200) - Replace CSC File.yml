name: Build Armbian (boca-tcn200) - Replace CSC File

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      BOARD: boca-tcn200
      ARMBIAN_REPO: https://github.com/alerice/armbian-build.git
      ARMBIAN_DIR: ./armbian-build  # 克隆的alerice仓库目录
      USER_CSC_FILE: ./Addboard/config/boards/boca-tcn200.csc  # 你仓库的csc文件路径
      TARGET_CSC_FILE: ./armbian-build/build/config/boards/boca-tcn200.csc  # 目标替换路径

    steps:
      # 步骤1：检出你自己的仓库（获取需要替换的csc文件）
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 这里fetch-depth=0是合法的（actions/checkout的参数，非git clone）

      # 步骤2：调试 - 检查你仓库的csc文件是否存在
      - name: Debug - Check user CSC file
        run: |
          echo "=== 检查你仓库的csc文件 ==="
          if [ -f "${{ env.USER_CSC_FILE }}" ]; then
            echo "✅ 找到你的csc文件：${{ env.USER_CSC_FILE }}"
            ls -la ${{ env.USER_CSC_FILE }}
          else
            echo "❌ 未找到你的csc文件：${{ env.USER_CSC_FILE }}"
            echo "请确认文件路径：Addboard/config/boards/boca-tcn200.csc 是否正确"
            exit 1
          fi

      # 步骤3：克隆alerice/armbian-build仓库（修复--depth参数问题）
      - name: Clone alerice/armbian-build repository
        run: |
          # 修复：去掉--depth=0，仅保留--recursive拉取子模块（完整克隆）
          git clone --recursive ${{ env.ARMBIAN_REPO }} ${{ env.ARMBIAN_DIR }}
          # 进入克隆后的目录，确认分支和提交信息
          cd ${{ env.ARMBIAN_DIR }}
          echo "=== 当前分支信息 ==="
          git branch -v
          echo "=== 最新提交信息 ==="
          git log -1

      # 步骤4：核心 - 替换csc文件
      - name: Replace boca-tcn200.csc file
        run: |
          # 先创建目标目录（避免目录不存在导致替换失败）
          mkdir -p $(dirname ${{ env.TARGET_CSC_FILE }})
          
          # 备份原文件（可选，方便排查问题）
          if [ -f "${{ env.TARGET_CSC_FILE }}" ]; then
            cp ${{ env.TARGET_CSC_FILE }} ${{ env.TARGET_CSC_FILE }}.bak
            echo "✅ 已备份原csc文件为：${{ env.TARGET_CSC_FILE }}.bak"
          fi
          
          # 执行替换
          cp -fv ${{ env.USER_CSC_FILE }} ${{ env.TARGET_CSC_FILE }}
          echo "✅ 已将你的csc文件替换到：${{ env.TARGET_CSC_FILE }}"
          
          # 验证替换结果
          echo "=== 验证替换后的文件 ==="
          ls -la ${{ env.TARGET_CSC_FILE }}
          cat ${{ env.TARGET_CSC_FILE }} | head -10  # 打印前10行确认内容

      # 步骤5：安装系统依赖
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y \
            git curl wget build-essential libncurses5-dev libssl-dev \
            bc flex bison kmod cpio rsync unzip zip qemu-user-static \
            python3 python3-pip python3-setuptools parted dosfstools \
            uuid-runtime grub-efi-amd64-bin grub-pc-bin mtools \
            libelf-dev libssl-dev dwarves zstd device-tree-compiler

      # 步骤6：初始化编译环境
      - name: Initialize build environment
        run: |
          cd ${{ env.ARMBIAN_DIR }}
          if [ -f "build.sh" ]; then
            chmod +x build.sh
            ./build.sh --help
          fi
          if [ -f "compile.sh" ]; then
            chmod +x compile.sh
          elif [ -f "build.sh" ]; then
            ln -s build.sh compile.sh
          else
            echo "错误：未找到编译脚本！"
            exit 1
          fi

      # 步骤7：执行编译
      - name: Build Armbian image
        run: |
          cd ${{ env.ARMBIAN_DIR }}
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=current \
            BUILD_MINIMAL=yes \
            BUILD_DESKTOP=no \
            KERNEL_ONLY=no \
            KERNEL_CONFIGURE=no

      # 步骤8：上传产物和日志
      - name: Upload build results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: armbian-boca-tcn200-results
          path: |
            ${{ env.ARMBIAN_DIR }}/output/images/*.img*
            ${{ env.ARMBIAN_DIR }}/output/images/*.zip*
            ${{ env.ARMBIAN_DIR }}/compile.log
            ${{ env.TARGET_CSC_FILE }}.bak  # 可选：上传备份的原csc文件
          retention-days: 7
