# .github/workflows/build-boca-tcn200.yml
name: Build Boca TCN200 Firmware

on:
  workflow_dispatch:  # 手动触发（推荐）
  push:
    tags:
      - 'v*.*.*'      # 标签触发发布

env:
  BOARD: boca-tcn200
  RELEASE: jammy      # Ubuntu 22.04 LTS（legacy/vendor 均兼容）
  # 关键优化：使用 /mnt 临时目录（GitHub Actions 提供额外 14GB 空间）
  ARMBIAN_WORKDIR: /mnt/armbian-work
  ARMBIAN_CACHE_DIR: /mnt/armbian-cache

jobs:
  setup-environment:
    name: Prepare Build Environment
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Check disk space
        run: df -h

      - name: Create workspace on /mnt (larger disk)
        run: |
          sudo mkdir -p ${{ env.ARMBIAN_WORKDIR }}
          sudo mkdir -p ${{ env.ARMBIAN_CACHE_DIR }}
          sudo chown -R $USER:$USER ${{ env.ARMBIAN_WORKDIR }}
          sudo chown -R $USER:$USER ${{ env.ARMBIAN_CACHE_DIR }}

      - name: Install Armbian build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache debootstrap flex \
            gawk gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf \
            git libncurses5-dev libssl-dev lsb-release lzop \
            python3-dev python3-pip python3-pexpect python3-setuptools \
            qemu-user-static u-boot-tools xz-utils zlib1g-dev \
            parted zip curl wget rsync dos2unix dialog \
            device-tree-compiler lz4 u-boot-tools

      - name: Generate cache key
        id: cache-key
        run: echo "key=armbian-deps-$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Cache toolchains (saves ~30 mins per build)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ARMBIAN_CACHE_DIR }}/toolchains
            ${{ env.ARMBIAN_CACHE_DIR }}/rootfs
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            armbian-deps-

  build-legacy:
    name: Build Legacy (Kernel 5.10)
    needs: setup-environment
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6小时超时（Armbian 编译耗时长）
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build

      - name: Prepare build directory
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          mkdir -p output

      - name: Build Legacy firmware (5.10)
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          # 关键优化：仅构建必要组件 + 清理中间文件
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=legacy \
            RELEASE=${{ env.RELEASE }} \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            CLEAN_LEVEL=2 \          # 2=编译后删除源码（节省 8GB+）
            EXTERNAL_NEW="yes" \     # 跳过交互式配置
            LIB_TAG="jammy" \
            KERNEL_KEEP_CONFIG="yes" \
            BOARD_NAME="Boca TCN200 (Legacy 5.10)" \
            2>&1 | tee build.log

      - name: Extract final images (only keep compressed .img.xz)
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          # 仅保留最终镜像和校验文件（<2GB）
          find output/images -type f \( -name "*.img.xz" -o -name "*.sha256" -o -name "*.txt" \) -exec cp {} ${{ env.ARMBIAN_WORKDIR }}/legacy-images/ \;
          ls -lh ${{ env.ARMBIAN_WORKDIR }}/legacy-images/

      - name: Upload legacy artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boca-tcn200-legacy
          path: ${{ env.ARMBIAN_WORKDIR }}/legacy-images/
          retention-days: 7

      - name: Save build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-legacy
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build/build.log
          retention-days: 3

  build-vendor:
    name: Build Vendor (Kernel 6.1)
    needs: setup-environment
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build

      - name: Prepare build directory
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          mkdir -p output

      - name: Build Vendor firmware (6.1)
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=current \         # current = vendor 6.1
            RELEASE=${{ env.RELEASE }} \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            CLEAN_LEVEL=2 \
            EXTERNAL_NEW="yes" \
            LIB_TAG="jammy" \
            KERNEL_KEEP_CONFIG="yes" \
            BOARD_NAME="Boca TCN200 (Vendor 6.1)" \
            2>&1 | tee build.log

      - name: Extract final images
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          find output/images -type f \( -name "*.img.xz" -o -name "*.sha256" -o -name "*.txt" \) -exec cp {} ${{ env.ARMBIAN_WORKDIR }}/vendor-images/ \;
          ls -lh ${{ env.ARMBIAN_WORKDIR }}/vendor-images/

      - name: Upload vendor artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boca-tcn200-vendor
          path: ${{ env.ARMBIAN_WORKDIR }}/vendor-images/
          retention-days: 7

      - name: Save build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-vendor
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build/build.log
          retention-days: 3

  release:
    name: Create GitHub Release
    needs: [build-legacy, build-vendor]
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download legacy artifacts
        uses: actions/download-artifact@v4
        with:
          name: boca-tcn200-legacy
          path: /tmp/legacy

      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: boca-tcn200-vendor
          path: /tmp/vendor

      - name: Prepare release assets
        run: |
          mkdir -p /tmp/release-assets
          
          # 重命名文件增加版本标识
          for f in /tmp/legacy/*; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            mv "$f" "/tmp/release-assets/Boca-TCN200-Legacy-5.10-${base}"
          done
          
          for f in /tmp/vendor/*; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            mv "$f" "/tmp/release-assets/Boca-TCN200-Vendor-6.1-${base}"
          done
          
          # 生成发布说明
          cat > /tmp/release-assets/RELEASE_NOTES.md << EOF
# Boca TCN200 Armbian Firmware

## Legacy Branch (Kernel 5.10.160)
- 稳定性优先，适合 7x24 小时 NAS 运行
- 完整硬件支持：双 SATA、Type-C USB 3.0、2K HDMI
- 补丁集：6 个 DTS 修复（音频/USB/显示/电源域）

## Vendor Branch (Kernel 6.1.84)
- 新特性支持：更新的驱动和安全补丁
- 精简补丁集（2 个），依赖上游内核改进
- 推荐用于需要新硬件支持的场景

## 刷机指南
1. 使用 balenaEtcher/Rufus 写入 SD 卡
2. 插入 Boca TCN200 SD 卡槽
3. 上电启动（首次启动约 5 分钟）
4. 默认用户：root / 1234（首次登录强制修改密码）

⚠️ **重要**：刷机前请备份数据！eMMC 刷写有变砖风险，建议先用 SD 卡测试。

## 已知问题
- SATA 热插拔需手动重新扫描：`echo "- - -" > /sys/class/scsi_host/host*/scan`
- 原厂 Android 分区表需完全覆盖（首次刷机建议全盘擦除）


- 本固件基于 commit: 1ca0b6f5db966dbe6c038736a95076ed78b2a10a
EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: Boca TCN200 Firmware ${{ github.ref_name }}
          body_path: /tmp/release-assets/RELEASE_NOTES.md
          files: |
            /tmp/release-assets/*.img.xz
            /tmp/release-assets/*.sha256
            /tmp/release-assets/RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Manual Release (for workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev-${{ github.run_number }}
          name: Development Build #${{ github.run_number }}
          body: |
            ⚠️ **开发构建** - 非正式发布版本
            
            包含：
            - Legacy (5.10): Boca-TCN200-Legacy-5.10-*.img.xz
            - Vendor (6.1): Boca-TCN200-Vendor-6.1-*.img.xz
            
            适用于测试目的，不建议生产环境使用。
          files: |
            /tmp/release-assets/*.img.xz
            /tmp/release-assets/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
