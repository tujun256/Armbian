name: Build Armbian

# 在创建 tag 时触发此工作流
on:
  push:
    tags:
      - 'v*' # 推送标签时触发，例如 v1.0, v2.0 等

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      # 定义矩阵，为每种桌面环境运行一次构建步骤
      matrix:
        branch: [legacy, vendor]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y debootstrap lvm2 kmod \
          dosfstools e2fsprogs parted binfmt-support qemu-user-static

    - name: Clone armbian-build repository
      # 我们使用一个已知的、稳定的 v24.8.1-trunk 版本，而不是 master 分支
      # 以确保构建的可重复性和稳定性
      run: |
        git clone --depth 1 --branch v24.8.1-trunk https://github.com/alerice/armbian-build.git

    - name: Prepare for build
      working-directory: ./armbian-build
      run: |
        # 创建一个配置文件来指定构建选项，避免交互式输入
        cat <<EOF > userpatches/config-default.conf
        BOARD=boca-tcn200
        BRANCH=${{ matrix.branch }}
        BUILD_DESKTOP=yes
        EOF
        echo "Build configuration created."

    - name: Build Armbian (${{ matrix.branch }})
      working-directory: ./armbian-build
      run: |
        # 运行编译命令
        # -t 表示终端模式，-c config-default.conf 指定配置文件
        ./compile.sh -t -c userpatches/config-default.conf

    # --- 新增步骤：将输出文件复制到一个单独的目录以便上传 ---
    - name: Copy outputs to a common directory
      run: |
        mkdir -p ./release_assets
        cp -r ./armbian-build/output/images/* ./release_assets/
        
    # --- 修改发布步骤：从新的公共目录上传 ---
    - name: Create Release and Upload Assets
      # 此步骤仅在所有矩阵构建都成功后执行一次
      if: ${{ success() }}
      uses: softprops/action-gh-release@v1
      with:
        # 发布的名称将包含 Git 提交的短哈希
        name: Release ${GITHUB_REF##*/}
        # 标签名称与推送的 tag 一致
        tag_name: ${{ github.ref_name }}
        # 生成发布的说明，列出本次构建的提交信息
        body: |
          Automated release for commit ${{ github.sha }}.
          
          Built images for boca-tcn200:
          - legacy
          - vendor
        # 将之前复制到 release_assets 目录下的所有文件作为发布资产
        files: |
          ./release_assets/**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
