name: Build Armbian Firmware

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      board:
        description: 'Target board (e.g., orangepi5, rock-5b, radxa-zero3)'
        required: true
        default: 'orangepi5'
      release:
        description: 'Target release (e.g., jammy, bookworm, noble)'
        required: true
        default: 'bookworm'
      build_desktop:
        description: 'Build desktop image'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'
          - 'minimal'

env:
  # ç¼–è¯‘é…ç½®
  BOARD: ${{ github.event.inputs.board || 'orangepi5' }}
  RELEASE: ${{ github.event.inputs.release || 'bookworm' }}
  BUILD_DESKTOP: ${{ github.event.inputs.build_desktop || 'no' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        branch: [legacy, vendor]
    
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: alerice/armbian-build
          fetch-depth: 0
          submodules: recursive
      
      - name: Show disk space
        run: df -h
      
      - name: Prepare build environment
        run: |
          # è®¾ç½® git é…ç½®
          git config --global user.email "builder@armbian.com"
          git config --global user.name "Armbian Builder"
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p output/images
          mkdir -p output/debs
          mkdir -p userpatches
      
      - name: Build Armbian (${{ matrix.branch }})
        run: |
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          BUILD_OPT="minimal"
          if [ "${BUILD_DESKTOP}" = "yes" ]; then
            BUILD_OPT="desktop"
          elif [ "${BUILD_DESKTOP}" = "no" ]; then
            BUILD_OPT="cli"
          fi
          
          echo "=========================================="
          echo "Building Armbian for:"
          echo "  Board: ${BOARD}"
          echo "  Branch: ${{ matrix.branch }}"
          echo "  Release: ${RELEASE}"
          echo "  Type: ${BUILD_OPT}"
          echo "=========================================="
          
          # æ‰§è¡Œç¼–è¯‘
          ./compile.sh \
            BOARD="${BOARD}" \
            BRANCH="${{ matrix.branch }}" \
            RELEASE="${RELEASE}" \
            BUILD_MINIMAL="${BUILD_OPT}" \
            BUILD_DESKTOP="${BUILD_DESKTOP}" \
            KERNEL_CONFIGURE="no" \
            KERNEL_ONLY="no" \
            COMPRESS_OUTPUTIMAGE="sha,gpg,xz" \
            EXPERT="yes" \
            NO_HOST_RELEASE="yes" \
            ALLOW_ROOT="yes" \
            INSTALL_KSRC="no" || true
          
          # å¦‚æžœä¸Šé¢çš„å‘½ä»¤å¤±è´¥ï¼Œå°è¯•ç®€åŒ–å‚æ•°
          if [ ! "$(ls -A output/images/*.img* 2>/dev/null)" ]; then
            echo "Retrying with minimal parameters..."
            ./compile.sh \
              BOARD="${BOARD}" \
              BRANCH="${{ matrix.branch }}" \
              RELEASE="${RELEASE}" \
              BUILD_OPT="${BUILD_OPT}" \
              KERNEL_CONFIGURE="no" || true
          fi
      
      - name: List output files
        run: |
          echo "=== Output Images ==="
          ls -lah output/images/ 2>/dev/null || echo "No images found"
          echo ""
          echo "=== Output Directory Structure ==="
          find output -type f -exec ls -lh {} \; 2>/dev/null || echo "No output files"
      
      - name: Prepare artifacts
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾äº§ç‰©
          ARTIFACT_DIR="release_${{ matrix.branch }}"
          mkdir -p "${ARTIFACT_DIR}"
          
          # å¤åˆ¶æ‰€æœ‰ç¼–è¯‘äº§ç‰©
          if [ -d "output/images" ]; then
            cp -v output/images/* "${ARTIFACT_DIR}/" 2>/dev/null || true
          fi
          
          # å¤åˆ¶æ—¥å¿—æ–‡ä»¶
          if [ -d "output/logs" ]; then
            cp -rv output/logs "${ARTIFACT_DIR}/" 2>/dev/null || true
          fi
          
          # ç”Ÿæˆæž„å»ºä¿¡æ¯
          cat > "${ARTIFACT_DIR}/build_info.txt" << EOF
          Armbian Build Information
          ========================
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Board: ${BOARD}
          Branch: ${{ matrix.branch }}
          Release: ${RELEASE}
          Desktop: ${BUILD_DESKTOP}
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.run_number }}
          EOF
          
          echo "=== Artifacts to upload ==="
          ls -lah "${ARTIFACT_DIR}/"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: armbian-${{ matrix.branch }}-${{ github.run_number }}
          path: release_${{ matrix.branch }}/*
          if-no-files-found: warn
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    
    steps:
      - name: Download legacy artifacts
        uses: actions/download-artifact@v4
        with:
          name: armbian-legacy-${{ github.run_number }}
          path: release/legacy
      
      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: armbian-vendor-${{ github.run_number }}
          path: release/vendor
      
      - name: List all release files
        run: |
          echo "=== All Release Files ==="
          find release -type f -exec ls -lh {} \;
      
      - name: Generate release tag
        id: tag
        run: |
          # ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
          TAG="v$(date -u +"%Y%m%d")-${{ github.run_number }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Armbian Firmware ${{ steps.tag.outputs.tag }}"
          body: |
            ## Armbian å›ºä»¶æž„å»º
            
            **æž„å»ºä¿¡æ¯:**
            - ðŸ“… æž„å»ºæ—¥æœŸ: ${{ github.event.head_commit.timestamp || 'N/A' }}
            - ðŸ–¥ï¸ ç›®æ ‡æ¿: `${{ github.event.inputs.board || 'orangepi5' }}`
            - ðŸ§ å‘è¡Œç‰ˆ: `${{ github.event.inputs.release || 'bookworm' }}`
            - ðŸ–¼ï¸ æ¡Œé¢çŽ¯å¢ƒ: `${{ github.event.inputs.build_desktop || 'no' }}`
            
            **å†…æ ¸åˆ†æ”¯:**
            - ðŸ“¦ **Legacy** - ä¼ ç»Ÿå†…æ ¸ç‰ˆæœ¬
            - ðŸ“¦ **Vendor** - åŽ‚å•†å†…æ ¸ç‰ˆæœ¬
            
            **æ–‡ä»¶è¯´æ˜Ž:**
            - `.img.xz` - åŽ‹ç¼©çš„å›ºä»¶é•œåƒæ–‡ä»¶
            - `.sha` - SHA256 æ ¡éªŒå’Œæ–‡ä»¶
            - `.asc` - GPG ç­¾åæ–‡ä»¶
            - `build_info.txt` - æž„å»ºä¿¡æ¯
            
            > âš ï¸ è¯·ä¸‹è½½å¯¹åº”å†…æ ¸ç‰ˆæœ¬çš„å›ºä»¶å¹¶æ ¡éªŒå®Œæ•´æ€§åŽä½¿ç”¨
          files: |
            release/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release Summary
        run: |
          echo "## âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Files:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find release -type f >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
