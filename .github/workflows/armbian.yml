# .github/workflows/armbian.yml
name: Armbian Build - Legacy & Vendor

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Target board name (e.g., nas-lite, rock-5b)'
        required: true
        default: 'nas-lite'
      release:
        description: 'Distribution release (bookworm/jammy)'
        required: true
        default: 'bookworm'
      desktop:
        description: 'Build with desktop environment'
        required: false
        default: 'no'
        type: boolean
      build_threads:
        description: 'Number of build threads (0 = auto)'
        required: false
        default: '0'

env:
  DEBIAN_FRONTEND: noninteractive
  BOARD: ${{ github.event.inputs.board }}
  RELEASE: ${{ github.event.inputs.release }}
  BUILD_DESKTOP: ${{ github.event.inputs.desktop == 'true' && 'yes' || 'no' }}
  BUILD_THREADS: ${{ github.event.inputs.build_threads }}

jobs:
  build:
    strategy:
      matrix:
        branch: [legacy, vendor]
      fail-fast: false

    runs-on: ubuntu-22.04
    env:
      BRANCH: ${{ matrix.branch }}

    steps:
      - name: Check resources
        run: |
          df -h / | grep -v Filesystem
          free -h
          echo "CPU cores: $(nproc)"

      - name: Checkout armbian-build
        uses: actions/checkout@v4
        with:
          repository: alerice/armbian-build
          path: armbian-build
          submodules: recursive

      - name: Install dependencies
        working-directory: armbian-build
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache debootstrap flex gawk \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf git \
            libc6-dev-armhf-cross libc6-dev-arm64-cross libncurses5-dev \
            libssl-dev lsb-release lzop python3 python3-dev python3-pip \
            python3-setuptools qemu-user-static u-boot-tools xz-utils \
            wget zip unzip rsync parted dosfstools btrfs-progs curl \
            pigz pv dialog whiptail ca-certificates

      - name: Configure ccache
        run: ccache --max-size=15G

      - name: Build Armbian (${{ matrix.branch }})
        working-directory: armbian-build
        run: |
          THREADS="${BUILD_THREADS:-$(nproc)}"
          echo "Building ${BOARD} with ${BRANCH} kernel on ${RELEASE} (threads: ${THREADS})"
          
          ./compile.sh \
            BOARD="${BOARD}" \
            BRANCH="${BRANCH}" \
            RELEASE="${RELEASE}" \
            BUILD_DESKTOP="${BUILD_DESKTOP}" \
            BUILD_MINIMAL=no \
            KERNEL_CONFIGURE=no \
            CLEAN_LEVEL="make,debs,images" \
            BUILD_THREADS="${THREADS}" \
            PROGRESS_LOG_TO_FILE=yes \
            2>&1 | tee "build-${BRANCH}.log" || {
              echo "::error::Build failed for ${BRANCH} kernel"
              tail -n 200 "build-${BRANCH}.log"
              exit 1
            }
          
          echo "::notice::Build successful for ${BRANCH} kernel"
          ls -lh output/images/ 2>/dev/null || echo "No images found (expected for some boards)"

      - name: Package output artifacts
        working-directory: armbian-build
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          OUTPUT_DIR="armbian-${BOARD}-${BRANCH}-${RELEASE}-${TIMESTAMP}"
          mkdir -p "${OUTPUT_DIR}"
          
          # Copy all output content preserving structure
          cp -r output/. "${OUTPUT_DIR}/" 2>/dev/null || mkdir -p "${OUTPUT_DIR}/empty"
          
          # Add build metadata
          cat > "${OUTPUT_DIR}/BUILD_INFO.txt" <<EOF
Board: ${BOARD}
Kernel Branch: ${BRANCH}
Release: ${RELEASE}
Desktop: ${BUILD_DESKTOP}
Build Date: $(date)
GitHub Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
EOF
          
          # Save build log
          cp "build-${BRANCH}.log" "${OUTPUT_DIR}/" 2>/dev/null || touch "${OUTPUT_DIR}/build.log.empty"
          
          # Create archive
          tar -czf "${OUTPUT_DIR}.tar.gz" "${OUTPUT_DIR}"
          sha256sum "${OUTPUT_DIR}.tar.gz" > "${OUTPUT_DIR}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: armbian-${{ matrix.branch }}-output
          path: |
            armbian-build/armbian-*-*.tar.gz
            armbian-build/armbian-*-*.sha256
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: armbian-*-output
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.board }}-v${{ github.run_number }}
          name: Armbian ${{ github.event.inputs.board }} Build #${{ github.run_number }}
          body: |
            ## Build Summary
            - **Board**: `${{ github.event.inputs.board }}`
            - **Release**: `${{ github.event.inputs.release }}`
            - **Desktop**: `${{ github.event.inputs.desktop }}`
            - **Date**: `$(date +%Y-%m-%d)`
            
            ### Artifacts Included
            - Full system images (`.img.xz`)
            - Kernel packages (`.deb`)
            - Build logs and debug info
            
            *Built with [alerice/armbian-build](https://github.com/alerice/armbian-build)*
          files: |
            artifacts/armbian-legacy-*.tar.gz
            artifacts/armbian-legacy-*.sha256
            artifacts/armbian-vendor-*.tar.gz
            artifacts/armbian-vendor-*.sha256
