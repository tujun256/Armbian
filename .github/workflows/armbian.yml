# .github/workflows/armbian.yml
name: Build Boca TCN200 Firmware

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

env:
  BOARD: boca-tcn200
  RELEASE: jammy
  ARMBIAN_WORKDIR: /mnt/armbian-work
  ARMBIAN_CACHE_DIR: /mnt/armbian-cache

jobs:
  build-legacy:
    name: Build Legacy (Kernel 5.10)
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: Check disk space
        run: df -h

      - name: Prepare workspace on /mnt
        run: |
          sudo mkdir -p ${{ env.ARMBIAN_WORKDIR }}
          sudo mkdir -p ${{ env.ARMBIAN_CACHE_DIR }}
          sudo chown -R $USER:$USER ${{ env.ARMBIAN_WORKDIR }}
          sudo chown -R $USER:$USER ${{ env.ARMBIAN_CACHE_DIR }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache debootstrap flex gawk gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf git libncurses5-dev libssl-dev lsb-release lzop python3-dev python3-pip python3-pexpect python3-setuptools qemu-user-static u-boot-tools xz-utils zlib1g-dev parted zip curl wget rsync dos2unix dialog device-tree-compiler lz4

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build

      - name: Build Legacy firmware
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          mkdir -p output
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=legacy \
            RELEASE=${{ env.RELEASE }} \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            CLEAN_LEVEL=2 \
            EXTERNAL_NEW="yes" \
            LIB_TAG="jammy" \
            KERNEL_KEEP_CONFIG="yes" \
            BOARD_NAME="Boca TCN200 (Legacy 5.10)" \
            2>&1 | tee build.log || echo "Build failed but continuing to collect artifacts"

      - name: Collect legacy images
        run: |
          mkdir -p ${{ env.ARMBIAN_WORKDIR }}/legacy-images
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          find output/images -type f \( -name "*.img.xz" -o -name "*.sha256" -o -name "*.txt" \) -exec cp {} ${{ env.ARMBIAN_WORKDIR }}/legacy-images/ \; 2>/dev/null || true
          ls -lh ${{ env.ARMBIAN_WORKDIR }}/legacy-images/ || echo "No images found"

      - name: Upload legacy artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boca-tcn200-legacy
          path: ${{ env.ARMBIAN_WORKDIR }}/legacy-images/
          retention-days: 7

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-legacy
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build/build.log
          retention-days: 3

  build-vendor:
    name: Build Vendor (Kernel 6.1)
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: Check disk space
        run: df -h

      - name: Prepare workspace on /mnt
        run: |
          sudo mkdir -p ${{ env.ARMBIAN_WORKDIR }}
          sudo mkdir -p ${{ env.ARMBIAN_CACHE_DIR }}
          sudo chown -R $USER:$USER ${{ env.ARMBIAN_WORKDIR }}
          sudo chown -R $USER:$USER ${{ env.ARMBIAN_CACHE_DIR }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache debootstrap flex gawk gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf git libncurses5-dev libssl-dev lsb-release lzop python3-dev python3-pip python3-pexpect python3-setuptools qemu-user-static u-boot-tools xz-utils zlib1g-dev parted zip curl wget rsync dos2unix dialog device-tree-compiler lz4

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build

      - name: Build Vendor firmware
        run: |
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          mkdir -p output
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=current \
            RELEASE=${{ env.RELEASE }} \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            CLEAN_LEVEL=2 \
            EXTERNAL_NEW="yes" \
            LIB_TAG="jammy" \
            KERNEL_KEEP_CONFIG="yes" \
            BOARD_NAME="Boca TCN200 (Vendor 6.1)" \
            2>&1 | tee build.log || echo "Build failed but continuing to collect artifacts"

      - name: Collect vendor images
        run: |
          mkdir -p ${{ env.ARMBIAN_WORKDIR }}/vendor-images
          cd ${{ env.ARMBIAN_WORKDIR }}/armbian-build
          find output/images -type f \( -name "*.img.xz" -o -name "*.sha256" -o -name "*.txt" \) -exec cp {} ${{ env.ARMBIAN_WORKDIR }}/vendor-images/ \; 2>/dev/null || true
          ls -lh ${{ env.ARMBIAN_WORKDIR }}/vendor-images/ || echo "No images found"

      - name: Upload vendor artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boca-tcn200-vendor
          path: ${{ env.ARMBIAN_WORKDIR }}/vendor-images/
          retention-days: 7

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-vendor
          path: ${{ env.ARMBIAN_WORKDIR }}/armbian-build/build.log
          retention-days: 3

  release:
    name: Create GitHub Release
    needs: [build-legacy, build-vendor]
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download legacy artifacts
        uses: actions/download-artifact@v4
        with:
          name: boca-tcn200-legacy
          path: /tmp/legacy

      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: boca-tcn200-vendor
          path: /tmp/vendor

      - name: Prepare release assets
        run: |
          mkdir -p /tmp/release-assets
          
          # Rename legacy files
          for f in /tmp/legacy/*; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            mv "$f" "/tmp/release-assets/Boca-TCN200-Legacy-5.10-${base}"
          done
          
          # Rename vendor files
          for f in /tmp/vendor/*; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            mv "$f" "/tmp/release-assets/Boca-TCN200-Vendor-6.1-${base}"
          done
          
          # Create release notes
          cat > /tmp/release-assets/RELEASE_NOTES.md << 'EOF'
# Boca TCN200 Armbian Firmware

## Legacy Branch (Kernel 5.10.160)
- 稳定性优先，适合 7x24 小时 NAS 运行
- 完整硬件支持：双 SATA、Type-C USB 3.0、2K HDMI
- 补丁集：6 个 DTS 修复（音频/USB/显示/电源域）

## Vendor Branch (Kernel 6.1.84)
- 新特性支持：更新的驱动和安全补丁
- 精简补丁集（2 个），依赖上游内核改进
- 推荐用于需要新硬件支持的场景

## 刷机指南
1. 使用 balenaEtcher/Rufus 写入 SD 卡
2. 插入 Boca TCN200 SD 卡槽
3. 上电启动（首次启动约 5 分钟）
4. 默认用户：root / 1234（首次登录强制修改密码）

⚠️ **重要**：刷机前请备份数据！eMMC 刷写有变砖风险，建议先用 SD 卡测试。

## 已知问题
- SATA 热插拔需手动重新扫描：`echo "- - -" > /sys/class/scsi_host/host*/scan`
- 原厂 Android 分区表需完全覆盖（首次刷机建议全盘擦除）

## 技术支持
- 恩山无线论坛：搜索 "Boca TCN200 Armbian"
- 本固件基于 commit: 1ca0b6f5db966dbe6c038736a95076ed78b2a10a
EOF

      - name: Create GitHub Release (tagged)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Boca TCN200 Firmware ${{ github.ref_name }}
          body_path: /tmp/release-assets/RELEASE_NOTES.md
          files: |
            /tmp/release-assets/*.img.xz
            /tmp/release-assets/*.sha256
            /tmp/release-assets/RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Development Release (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev-${{ github.run_number }}
          name: Development Build #${{ github.run_number }}
          body: |
            ⚠️ **开发构建** - 非正式发布版本
            
            包含：
            - Legacy (5.10): Boca-TCN200-Legacy-5.10-*.img.xz
            - Vendor (6.1): Boca-TCN200-Vendor-6.1-*.img.xz
            
            适用于测试目的，不建议生产环境使用。
          files: |
            /tmp/release-assets/*.img.xz
            /tmp/release-assets/*.sha256
            /tmp/release-assets/RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
