name: Build Armbian Firmware

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      board:
        description: 'Target board (e.g., orangepi5, rock-5b, radxa-zero3)'
        required: true
        default: 'orangepi5'
      release:
        description: 'Target release (e.g., jammy, bookworm, noble)'
        required: true
        default: 'bookworm'
      build_desktop:
        description: 'Build desktop image'
        required: true
        default: 'server'
        type: choice
        options:
          - 'server'
          - 'desktop'
          - 'minimal'

env:
  BOARD: ${{ github.event.inputs.board || 'orangepi5' }}
  RELEASE: ${{ github.event.inputs.release || 'bookworm' }}
  BUILD_DESKTOP: ${{ github.event.inputs.build_desktop || 'server' }}

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: alerice/armbian-build
          fetch-depth: 0
          submodules: recursive
      
      - name: Get supported branches
        id: set-matrix
        run: |
          # å®šä¹‰è¦ç¼–è¯‘çš„åˆ†æ”¯
          # å¯¹äºŽ orangepi5: edge, current, vendor
          # å¦‚æžœéœ€è¦ç‰¹å®šåˆ†æ”¯ï¼Œå¯ä»¥ä¿®æ”¹è¿™é‡Œ
          MATRIX='{"branch":["current","vendor"]}'
          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT
          echo "Build matrix: ${MATRIX}"

  build:
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: alerice/armbian-build
          fetch-depth: 0
          submodules: recursive
      
      - name: Show disk space
        run: df -h
      
      - name: Prepare build environment
        run: |
          git config --global user.email "builder@armbian.com"
          git config --global user.name "Armbian Builder"
          
          mkdir -p output/images
          mkdir -p output/logs
          mkdir -p userpatches
          
          # åˆ›å»ºè‡ªåŠ¨åº”ç­”é…ç½®ï¼Œé¿å…äº¤äº’å¼ dialog
          cat > userpatches/config-default.conf << 'EOF'
          # éžäº¤äº’æ¨¡å¼è®¾ç½®
          NO_HOST_RELEASE="yes"
          EOF
      
      - name: Build Armbian (${{ matrix.branch }})
        run: |
          # è®¾ç½®æž„å»ºç±»åž‹
          BUILD_OPT=""
          case "${BUILD_DESKTOP}" in
            "server")
              BUILD_OPT="server"
              ;;
            "desktop")
              BUILD_OPT="desktop"
              ;;
            "minimal")
              BUILD_OPT="minimal"
              ;;
            *)
              BUILD_OPT="server"
              ;;
          esac
          
          echo "=========================================="
          echo "Building Armbian:"
          echo "  Board: ${BOARD}"
          echo "  Branch: ${{ matrix.branch }}"
          echo "  Release: ${RELEASE}"
          echo "  Type: ${BUILD_OPT}"
          echo "=========================================="
          
          # ä½¿ç”¨æ–°çš„ CLI å‘½ä»¤æ ¼å¼æž„å»ºå®Œæ•´é•œåƒ
          # EXPERT=yes å…è®¸ä½¿ç”¨éžäº¤äº’æ¨¡å¼
          ./compile.sh \
            BOARD="${BOARD}" \
            BRANCH="${{ matrix.branch }}" \
            RELEASE="${RELEASE}" \
            BUILD_OPT="${BUILD_OPT}" \
            EXPERT="yes" \
            COMPRESS_OUTPUTIMAGE="sha,xz" \
            NO_HOST_RELEASE="yes" \
            ALLOW_ROOT="yes"
      
      - name: List output files
        run: |
          echo "=== Output Images ==="
          ls -lah output/images/ 2>/dev/null || echo "No images found"
          echo ""
          echo "=== Output Logs ==="
          ls -lah output/logs/ 2>/dev/null || echo "No logs found"
          echo ""
          echo "=== All Output Files ==="
          find output -type f -exec ls -lh {} \; 2>/dev/null || echo "No output files"
      
      - name: Prepare artifacts
        run: |
          ARTIFACT_DIR="release_${{ matrix.branch }}"
          mkdir -p "${ARTIFACT_DIR}"
          
          # å¤åˆ¶é•œåƒæ–‡ä»¶
          if [ -d "output/images" ]; then
            find output/images -type f \( -name "*.img*" -o -name "*.sha" -o -name "*.asc" \) \
              -exec cp -v {} "${ARTIFACT_DIR}/" \; 2>/dev/null || true
          fi
          
          # å¤åˆ¶æ—¥å¿—
          if [ -d "output/logs" ]; then
            cp -rv output/logs/* "${ARTIFACT_DIR}/" 2>/dev/null || true
          fi
          
          # ç”Ÿæˆæž„å»ºä¿¡æ¯
          cat > "${ARTIFACT_DIR}/build_info.txt" << EOF
          Armbian Build Information
          ========================
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Board: ${BOARD}
          Branch: ${{ matrix.branch }}
          Release: ${RELEASE}
          Desktop: ${BUILD_DESKTOP}
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.run_number }}
          Repository: ${{ github.repository }}
          EOF
          
          echo "=== Artifacts ==="
          ls -lah "${ARTIFACT_DIR}/" || echo "No artifacts"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A ${ARTIFACT_DIR} 2>/dev/null)" ]; then
            echo "Warning: No artifacts generated!"
            # åˆ›å»ºä¸€ä¸ªå ä½æ–‡ä»¶
            echo "Build failed or no output" > "${ARTIFACT_DIR}/build_status.txt"
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: armbian-${{ matrix.branch }}-${{ github.run_number }}
          path: release_${{ matrix.branch }}/*
          if-no-files-found: warn
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    
    steps:
      - name: Download current artifacts
        uses: actions/download-artifact@v4
        with:
          name: armbian-current-${{ github.run_number }}
          path: release/current
        continue-on-error: true
      
      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: armbian-vendor-${{ github.run_number }}
          path: release/vendor
        continue-on-error: true
      
      - name: List all release files
        run: |
          echo "=== All Release Files ==="
          find release -type f -exec ls -lh {} \; 2>/dev/null || echo "No files"
      
      - name: Check artifacts exist
        id: check
        run: |
          if [ -d "release" ] && [ "$(find release -type f | wc -l)" -gt 0 ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "No artifacts found, skipping release"
          fi
      
      - name: Generate release tag
        if: steps.check.outputs.has_files == 'true'
        id: tag
        run: |
          TAG="v$(date -u +"%Y%m%d")-${{ github.run_number }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"
      
      - name: Create Release
        if: steps.check.outputs.has_files == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Armbian Firmware ${{ steps.tag.outputs.tag }}"
          body: |
            ## Armbian å›ºä»¶æž„å»º
            
            **æž„å»ºä¿¡æ¯:**
            - ðŸ“… æž„å»ºæ—¥æœŸ: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - ðŸ–¥ï¸ ç›®æ ‡æ¿: \`${{ github.event.inputs.board || 'orangepi5' }}\`
            - ðŸ§ å‘è¡Œç‰ˆ: \`${{ github.event.inputs.release || 'bookworm' }}\`
            - ðŸ–¼ï¸ æž„å»ºç±»åž‹: \`${{ github.event.inputs.build_desktop || 'server' }}\`
            
            **å†…æ ¸åˆ†æ”¯:**
            - ðŸ“¦ **current** - ç¨³å®šçš„ä¸»çº¿å†…æ ¸
            - ðŸ“¦ **vendor** - åŽ‚å•†æä¾›çš„å†…æ ¸
            
            **æ–‡ä»¶è¯´æ˜Ž:**
            - `.img.xz` - åŽ‹ç¼©çš„å›ºä»¶é•œåƒæ–‡ä»¶
            - `.sha` - SHA256 æ ¡éªŒå’Œæ–‡ä»¶
            - `build_info.txt` - æž„å»ºä¿¡æ¯
            
            > âš ï¸ è¯·ä¸‹è½½å¯¹åº”å†…æ ¸ç‰ˆæœ¬çš„å›ºä»¶å¹¶æ ¡éªŒå®Œæ•´æ€§åŽä½¿ç”¨
          files: |
            release/current/*
            release/vendor/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release Summary
        if: steps.check.outputs.has_files == 'true'
        run: |
          echo "## âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Files:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find release -type f 2>/dev/null >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
