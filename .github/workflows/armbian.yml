# .github/workflows/armbian.yml
name: Armbian Build

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Target board name (e.g., nas-lite)'
        required: true
        default: 'nas-lite'
      release:
        description: 'Distribution release (bookworm/jammy)'
        required: true
        default: 'bookworm'
      desktop:
        description: 'Build with desktop environment'
        required: false
        default: 'no'
        type: boolean

jobs:
  build:
    strategy:
      matrix:
        branch: [legacy, vendor]
      fail-fast: false

    runs-on: ubuntu-22.04
    env:
      BOARD: ${{ github.event.inputs.board }}
      BRANCH: ${{ matrix.branch }}
      RELEASE: ${{ github.event.inputs.release }}
      BUILD_DESKTOP: ${{ github.event.inputs.desktop == 'true' && 'yes' || 'no' }}

    steps:
      - name: Check disk space
        run: |
          df -h / | tail -1
          free -h | grep Mem

      - name: Checkout armbian-build
        uses: actions/checkout@v4
        with:
          repository: alerice/armbian-build
          path: armbian-build
          submodules: recursive

      - name: Install dependencies
        working-directory: armbian-build
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bc bison build-essential ccache debootstrap flex gawk gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf git libc6-dev-armhf-cross libc6-dev-arm64-cross libncurses5-dev libssl-dev lsb-release lzop python3 python3-dev python3-pip python3-setuptools qemu-user-static u-boot-tools xz-utils wget zip unzip rsync parted dosfstools btrfs-progs curl pigz pv dialog whiptail ca-certificates

      - name: Build Armbian
        working-directory: armbian-build
        run: |
          ./compile.sh BOARD="${BOARD}" BRANCH="${BRANCH}" RELEASE="${RELEASE}" BUILD_DESKTOP="${BUILD_DESKTOP}" BUILD_MINIMAL=no KERNEL_CONFIGURE=no CLEAN_LEVEL="make,debs,images" BUILD_THREADS="$(nproc)" PROGRESS_LOG_TO_FILE=yes 2>&1 | tee build.log || { tail -n 200 build.log; exit 1; }
          echo "Build completed successfully"

      - name: Package artifacts
        working-directory: armbian-build
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          OUTPUT_DIR="armbian-${BOARD}-${BRANCH}-${RELEASE}-${TIMESTAMP}"
          mkdir -p "${OUTPUT_DIR}"
          cp -r output/. "${OUTPUT_DIR}/" 2>/dev/null || true
          cat > "${OUTPUT_DIR}/BUILD_INFO.txt" << EOF
Board: ${BOARD}
Kernel Branch: ${BRANCH}
Release: ${RELEASE}
Desktop: ${BUILD_DESKTOP}
Build Date: $(date)
Workflow Run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
EOF
          cp build.log "${OUTPUT_DIR}/" 2>/dev/null || true
          tar -czf "${OUTPUT_DIR}.tar.gz" "${OUTPUT_DIR}"
          sha256sum "${OUTPUT_DIR}.tar.gz" > "${OUTPUT_DIR}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: armbian-${{ matrix.branch }}
          path: |
            armbian-build/armbian-*.tar.gz
            armbian-build/armbian-*.sha256
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.board }}-v${{ github.run_number }}
          name: Armbian ${{ github.event.inputs.board }} Build #${{ github.run_number }}
          body: |
            Board: ${{ github.event.inputs.board }}
            Release: ${{ github.event.inputs.release }}
            Desktop: ${{ github.event.inputs.desktop }}
            Date: $(date +%Y-%m-%d)
            
            Built with https://github.com/alerice/armbian-build
          files: |
            artifacts/armbian-legacy/*.tar.gz
            artifacts/armbian-legacy/*.sha256
            artifacts/armbian-vendor/*.tar.gz
            artifacts/armbian-vendor/*.sha256
