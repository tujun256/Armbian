# .github/workflows/armbian-build.yml
name: Armbian Build - Legacy & Vendor

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Target board name (e.g., nas-lite, rock-5b)'
        required: true
        default: 'nas-lite'
      release:
        description: 'Distribution release (bookworm/jammy)'
        required: true
        default: 'bookworm'
      desktop:
        description: 'Build with desktop environment'
        required: false
        default: 'no'
        type: boolean
      build_threads:
        description: 'Number of build threads (default: auto-detect)'
        required: false
        default: '0'

env:
  # 基础环境变量
  DEBIAN_FRONTEND: noninteractive
  BUILD_THREADS: ${{ github.event.inputs.build_threads || '0' }}
  BOARD: ${{ github.event.inputs.board }}
  RELEASE: ${{ github.event.inputs.release }}
  BUILD_DESKTOP: ${{ github.event.inputs.desktop == 'true' && 'yes' || 'no' }}

jobs:
  build:
    strategy:
      matrix:
        branch: [legacy, vendor]
        # 注意：legacy/vendor 内核支持因板子而异，某些板子可能只支持其中一种
      fail-fast: false  # 一个失败不影响另一个

    runs-on: ubuntu-22.04
    # ⚠️ 重要：Armbian 编译需要大量资源
    # - 磁盘空间：至少 80GB（建议 100GB+）
    # - 内存：至少 8GB（建议 16GB+）
    # - GitHub Actions 免费 runner 可能超时（6小时限制）
    # 建议：使用 self-hosted runner 或考虑分阶段编译

    env:
      BRANCH: ${{ matrix.branch }}

    steps:
      - name: Check disk space & memory
        run: |
          echo "=== Disk Space ==="
          df -h /
          echo "=== Memory ==="
          free -h
          echo "=== CPU Cores ==="
          nproc

      - name: Checkout armbian-build
        uses: actions/checkout@v4
        with:
          repository: alerice/armbian-build
          path: armbian-build
          submodules: recursive

      - name: Install build dependencies
        working-directory: armbian-build
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc \
            bison \
            build-essential \
            ccache \
            debootstrap \
            flex \
            gawk \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabihf \
            git \
            libc6-dev-armhf-cross \
            libc6-dev-arm64-cross \
            libncurses5-dev \
            libssl-dev \
            lsb-release \
            lzop \
            python3 \
            python3-dev \
            python3-pip \
            python3-setuptools \
            qemu-user-static \
            u-boot-tools \
            xz-utils \
            wget \
            zip \
            unzip \
            rsync \
            parted \
            dosfstools \
            btrfs-progs \
            curl \
            pigz \
            pv \
            dialog \
            whiptail

      - name: Configure ccache (optional but recommended)
        run: |
          ccache --max-size=20G
          ccache -s

      - name: Build Armbian - ${{ matrix.branch }} kernel
        working-directory: armbian-build
        run: |
          # 设置编译线程数（0 = 自动检测）
          THREADS=${BUILD_THREADS:-$(nproc)}
          
          echo "=== Starting Armbian build ==="
          echo "Board: ${BOARD}"
          echo "Branch: ${BRANCH}"
          echo "Release: ${RELEASE}"
          echo "Desktop: ${BUILD_DESKTOP}"
          echo "Threads: ${THREADS}"
          echo "==============================="
          
          # 执行完整固件编译（非仅内核）
          ./compile.sh \
            BOARD=${BOARD} \
            BRANCH=${BRANCH} \
            RELEASE=${RELEASE} \
            BUILD_DESKTOP=${BUILD_DESKTOP} \
            BUILD_MINIMAL=no \
            KERNEL_CONFIGURE=no \
            CLEAN_LEVEL="make,debs,images" \
            BUILD_THREADS=${THREADS} \
            PROGRESS_LOG_TO_FILE=yes \
            2>&1 | tee build-${BRANCH}.log || {
              echo "=== Build failed - showing last 200 lines of log ==="
              tail -n 200 build-${BRANCH}.log
              exit 1
            }
          
          echo "=== Build completed successfully ==="
          ls -lh output/images/

      - name: Collect build artifacts
        working-directory: armbian-build
        run: |
          # 创建带分支标识的输出目录
          OUTPUT_DIR="armbian-${BOARD}-${BRANCH}-${RELEASE}-$(date +%Y%m%d)"
          mkdir -p "${OUTPUT_DIR}"
          
          # 复制所有 output 内容
          cp -r output/* "${OUTPUT_DIR}/"
          
          # 保存构建日志
          cp build-${BRANCH}.log "${OUTPUT_DIR}/build.log"
          
          # 创建清单文件
          echo "Board: ${BOARD}" > "${OUTPUT_DIR}/BUILD_INFO.txt"
          echo "Kernel Branch: ${BRANCH}" >> "${OUTPUT_DIR}/BUILD_INFO.txt"
          echo "Release: ${RELEASE}" >> "${OUTPUT_DIR}/BUILD_INFO.txt"
          echo "Desktop: ${BUILD_DESKTOP}" >> "${OUTPUT_DIR}/BUILD_INFO.txt"
          echo "Build Date: $(date)" >> "${OUTPUT_DIR}/BUILD_INFO.txt"
          echo "GitHub Actions Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> "${OUTPUT_DIR}/BUILD_INFO.txt"
          
          # 打包（保留原始目录结构）
          tar -czf "${OUTPUT_DIR}.tar.gz" "${OUTPUT_DIR}"
          
          # 计算校验和
          sha256sum "${OUTPUT_DIR}.tar.gz" > "${OUTPUT_DIR}.sha256"

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: armbian-${{ matrix.branch }}-output
          path: |
            armbian-build/armbian-*-output.tar.gz
            armbian-build/armbian-*-output.sha256
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repo (for release notes)
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.board }}-v${{ github.run_number }}
          name: Armbian ${{ github.event.inputs.board }} - Build #${{ github.run_number }}
          body: |
            ## Armbian Build Summary
            
            - **Board**: `${{ github.event.inputs.board }}`
            - **Release**: `${{ github.event.inputs.release }}`
            - **Desktop**: `${{ github.event.inputs.desktop }}`
            - **Build Date**: `$(date +%Y-%m-%d)`
            - **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### Included Artifacts
            
            #### Legacy Kernel Branch
            - Full system images (`*.img.xz`)
            - Kernel packages (`*.deb`)
            - Build logs and debug info
            
            #### Vendor Kernel Branch
            - Full system images (`*.img.xz`)
            - Kernel packages (`*.deb`)
            - Build logs and debug info
            
            ---
            
            *Built with [alerice/armbian-build](https://github.com/alerice/armbian-build)*
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.sha256

      - name: Cleanup artifacts (optional)
        if: success()
        run: rm -rf artifacts
