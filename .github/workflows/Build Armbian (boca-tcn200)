# 工作流名称
name: Build Armbian (boca-tcn200)

# 触发方式：手动触发（推荐，避免频繁编译）+ push到main分支时触发（可选）
on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
    paths-ignore:  # 忽略文档类文件的修改，避免不必要的编译
      - '**.md'
      - 'LICENSE'
      - 'README*'

# 作业配置
jobs:
  build:
    # 运行环境：Ubuntu 22.04（Armbian编译推荐的系统版本）
    runs-on: ubuntu-22.04
    # 增加虚拟机资源（编译Armbian需要更多内存/CPU）
    env:
      DEBIAN_FRONTEND: noninteractive  # 禁用交互模式，避免安装依赖时卡住
      BOARD: boca-tcn200  # 指定编译的BOARD
    steps:
      # 步骤1：检出armbian-build仓库代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整的提交历史（Armbian编译需要）
          submodules: recursive  # 拉取子模块

      # 步骤2：安装系统依赖（Armbian编译必需）
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          # 安装Armbian编译的核心依赖
          sudo apt install -y \
            git curl wget build-essential libncurses5-dev libssl-dev \
            bc flex bison kmod cpio rsync unzip zip qemu-user-static \
            python3 python3-pip python3-setuptools parted dosfstools \
            uuid-runtime grub-efi-amd64-bin grub-pc-bin mtools \
            libelf-dev libssl-dev dwarves zstd device-tree-compiler

      # 步骤3：配置编译环境并执行编译
      - name: Build Armbian image
        run: |
          # 赋予编译脚本执行权限
          chmod +x compile.sh
          # 执行编译命令（BOARD指定为boca-tcn200）
          ./compile.sh BOARD=${{ env.BOARD }} \
            BRANCH=current \  # 可选：指定内核分支（current/latest/edge）
            BUILD_MINIMAL=yes \  # 可选：编译最小化镜像（yes/no）
            BUILD_DESKTOP=no  # 可选：是否编译桌面版（yes/no）

      # 步骤4：上传编译产物（关键！保存生成的镜像文件）
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: armbian-${{ env.BOARD }}-image
          # Armbian编译产物默认存放在output/images目录
          path: |
            output/images/*.img
            output/images/*.zip
            output/images/*.sha
          retention-days: 7  # 产物保留7天（可根据需要调整）
